# NOTE: Assertions have been autogenerated by utils/update_mir_test_checks.py UTC_ARGS: --version 4
# RUN: llc -mtriple=amdgcn--amdhsa -mcpu=gfx900 -amdgpu-disable-unclustered-high-rp-reschedule -verify-machineinstrs -start-before=machine-scheduler -stop-after=virtregrewriter,1 -o - %s | FileCheck -check-prefix=GCN %s

# Check that %3 was not rematerialized before the last store since its operand %1
# is killed by that store.

---
name:            global_sextload_v32i32_to_v32i64
tracksRegLiveness: true
machineFunctionInfo:
  scratchRSrcReg:  '$sgpr96_sgpr97_sgpr98_sgpr99'
  stackPtrOffsetReg: '$sgpr32'
body:             |
  bb.0:
    liveins: $sgpr4_sgpr5

    ; GCN-LABEL: name: global_sextload_v32i32_to_v32i64
    ; GCN: liveins: $sgpr4_sgpr5
    ; GCN-NEXT: {{  $}}
    ; GCN-NEXT: renamable $vgpr4 = COPY $m0
    ; GCN-NEXT: renamable $sgpr0_sgpr1_sgpr2_sgpr3 = S_LOAD_DWORDX4_IMM killed renamable $sgpr4_sgpr5, 0, 0
    ; GCN-NEXT: renamable $vgpr5 = V_MOV_B32_e32 $vgpr4, implicit $exec
    ; GCN-NEXT: renamable $vgpr6_vgpr7_vgpr8_vgpr9 = GLOBAL_LOAD_DWORDX4_SADDR renamable $sgpr2_sgpr3, renamable $vgpr5, 112, 0, implicit $exec :: (load (s128))
    ; GCN-NEXT: renamable $vgpr10_vgpr11_vgpr12_vgpr13 = GLOBAL_LOAD_DWORDX4_SADDR renamable $sgpr2_sgpr3, renamable $vgpr5, 96, 0, implicit $exec, implicit renamable $vgpr4 :: (load (s128))
    ; GCN-NEXT: renamable $vgpr14_vgpr15_vgpr16_vgpr17 = GLOBAL_LOAD_DWORDX4_SADDR renamable $sgpr2_sgpr3, renamable $vgpr5, 80, 0, implicit $exec :: (load (s128))
    ; GCN-NEXT: renamable $vgpr0_vgpr1_vgpr2_vgpr3 = GLOBAL_LOAD_DWORDX4_SADDR renamable $sgpr2_sgpr3, renamable $vgpr5, 0, 0, implicit $exec :: (load (s128))
    ; GCN-NEXT: renamable $vgpr18_vgpr19_vgpr20_vgpr21 = GLOBAL_LOAD_DWORDX4_SADDR renamable $sgpr2_sgpr3, renamable $vgpr5, 64, 0, implicit $exec :: (load (s128))
    ; GCN-NEXT: renamable $vgpr22_vgpr23_vgpr24_vgpr25 = GLOBAL_LOAD_DWORDX4_SADDR renamable $sgpr2_sgpr3, renamable $vgpr5, 16, 0, implicit $exec :: (load (s128))
    ; GCN-NEXT: renamable $vgpr26_vgpr27_vgpr28_vgpr29 = GLOBAL_LOAD_DWORDX4_SADDR renamable $sgpr2_sgpr3, renamable $vgpr5, 48, 0, implicit $exec :: (load (s128))
    ; GCN-NEXT: renamable $vgpr33 = V_ASHRREV_I32_e32 31, $vgpr7, implicit $exec
    ; GCN-NEXT: renamable $vgpr31 = V_ASHRREV_I32_e32 31, $vgpr6, implicit $exec
    ; GCN-NEXT: renamable $vgpr30 = COPY renamable $vgpr6
    ; GCN-NEXT: renamable $vgpr32 = COPY renamable $vgpr7
    ; GCN-NEXT: renamable $vgpr34_vgpr35_vgpr36_vgpr37 = GLOBAL_LOAD_DWORDX4_SADDR renamable $sgpr2_sgpr3, renamable $vgpr5, 32, 0, implicit $exec :: (load (s128))
    ; GCN-NEXT: GLOBAL_STORE_DWORDX4_SADDR renamable $vgpr5, killed renamable $vgpr30_vgpr31_vgpr32_vgpr33, renamable $sgpr0_sgpr1, 224, 0, implicit $exec
    ; GCN-NEXT: renamable $vgpr33 = V_ASHRREV_I32_e32 31, $vgpr9, implicit $exec
    ; GCN-NEXT: renamable $vgpr31 = V_ASHRREV_I32_e32 31, $vgpr8, implicit $exec
    ; GCN-NEXT: renamable $vgpr30 = COPY renamable $vgpr8
    ; GCN-NEXT: renamable $vgpr32 = COPY killed renamable $vgpr9
    ; GCN-NEXT: GLOBAL_STORE_DWORDX4_SADDR renamable $vgpr5, killed renamable $vgpr30_vgpr31_vgpr32_vgpr33, renamable $sgpr0_sgpr1, 240, 0, implicit $exec
    ; GCN-NEXT: renamable $vgpr9 = V_ASHRREV_I32_e32 31, $vgpr11, implicit $exec
    ; GCN-NEXT: renamable $vgpr7 = V_ASHRREV_I32_e32 31, $vgpr10, implicit $exec
    ; GCN-NEXT: renamable $vgpr6 = COPY renamable $vgpr10
    ; GCN-NEXT: renamable $vgpr8 = COPY renamable $vgpr11
    ; GCN-NEXT: GLOBAL_STORE_DWORDX4_SADDR renamable $vgpr5, killed renamable $vgpr6_vgpr7_vgpr8_vgpr9, renamable $sgpr0_sgpr1, 192, 0, implicit $exec
    ; GCN-NEXT: renamable $vgpr9 = V_ASHRREV_I32_e32 31, $vgpr13, implicit $exec
    ; GCN-NEXT: renamable $vgpr7 = V_ASHRREV_I32_e32 31, $vgpr12, implicit $exec
    ; GCN-NEXT: renamable $vgpr6 = COPY renamable $vgpr12
    ; GCN-NEXT: renamable $vgpr8 = COPY killed renamable $vgpr13
    ; GCN-NEXT: renamable $vgpr13 = V_ASHRREV_I32_e32 31, $vgpr15, implicit $exec
    ; GCN-NEXT: renamable $vgpr11 = V_ASHRREV_I32_e32 31, $vgpr14, implicit $exec
    ; GCN-NEXT: renamable $vgpr10 = COPY renamable $vgpr14
    ; GCN-NEXT: renamable $vgpr12 = COPY renamable $vgpr15
    ; GCN-NEXT: GLOBAL_STORE_DWORDX4_SADDR renamable $vgpr5, killed renamable $vgpr6_vgpr7_vgpr8_vgpr9, renamable $sgpr0_sgpr1, 208, 0, implicit $exec
    ; GCN-NEXT: renamable $vgpr9 = V_ASHRREV_I32_e32 31, $vgpr3, implicit $exec
    ; GCN-NEXT: renamable $vgpr33 = V_ASHRREV_I32_e32 31, $vgpr17, implicit $exec
    ; GCN-NEXT: renamable $vgpr31 = V_ASHRREV_I32_e32 31, $vgpr16, implicit $exec
    ; GCN-NEXT: renamable $vgpr7 = V_ASHRREV_I32_e32 31, $vgpr2, implicit $exec
    ; GCN-NEXT: renamable $vgpr30 = COPY renamable $vgpr16
    ; GCN-NEXT: renamable $vgpr32 = COPY killed renamable $vgpr17
    ; GCN-NEXT: GLOBAL_STORE_DWORDX4_SADDR renamable $vgpr5, killed renamable $vgpr10_vgpr11_vgpr12_vgpr13, renamable $sgpr0_sgpr1, 160, 0, implicit $exec
    ; GCN-NEXT: renamable $vgpr13 = V_ASHRREV_I32_e32 31, $vgpr1, implicit $exec
    ; GCN-NEXT: renamable $vgpr11 = V_ASHRREV_I32_e32 31, $vgpr0, implicit $exec
    ; GCN-NEXT: renamable $vgpr17 = V_ASHRREV_I32_e32 31, $vgpr19, implicit $exec
    ; GCN-NEXT: renamable $vgpr15 = V_ASHRREV_I32_e32 31, $vgpr18, implicit $exec
    ; GCN-NEXT: renamable $vgpr14 = COPY renamable $vgpr18
    ; GCN-NEXT: renamable $vgpr16 = COPY renamable $vgpr19
    ; GCN-NEXT: GLOBAL_STORE_DWORDX4_SADDR renamable $vgpr5, killed renamable $vgpr30_vgpr31_vgpr32_vgpr33, renamable $sgpr0_sgpr1, 176, 0, implicit $exec
    ; GCN-NEXT: renamable $vgpr32 = V_ASHRREV_I32_e32 31, $vgpr25, implicit $exec
    ; GCN-NEXT: renamable $vgpr51 = V_ASHRREV_I32_e32 31, $vgpr21, implicit $exec
    ; GCN-NEXT: renamable $vgpr49 = V_ASHRREV_I32_e32 31, $vgpr20, implicit $exec
    ; GCN-NEXT: renamable $vgpr30 = V_ASHRREV_I32_e32 31, $vgpr24, implicit $exec
    ; GCN-NEXT: renamable $vgpr48 = COPY renamable $vgpr20
    ; GCN-NEXT: renamable $vgpr50 = COPY killed renamable $vgpr21
    ; GCN-NEXT: GLOBAL_STORE_DWORDX4_SADDR renamable $vgpr5, killed renamable $vgpr14_vgpr15_vgpr16_vgpr17, renamable $sgpr0_sgpr1, 128, 0, implicit $exec
    ; GCN-NEXT: renamable $vgpr17 = V_ASHRREV_I32_e32 31, $vgpr23, implicit $exec
    ; GCN-NEXT: renamable $vgpr15 = V_ASHRREV_I32_e32 31, $vgpr22, implicit $exec
    ; GCN-NEXT: renamable $vgpr21 = V_ASHRREV_I32_e32 31, $vgpr27, implicit $exec
    ; GCN-NEXT: renamable $vgpr19 = V_ASHRREV_I32_e32 31, $vgpr26, implicit $exec
    ; GCN-NEXT: renamable $vgpr18 = COPY renamable $vgpr26
    ; GCN-NEXT: renamable $vgpr20 = COPY renamable $vgpr27
    ; GCN-NEXT: GLOBAL_STORE_DWORDX4_SADDR renamable $vgpr5, killed renamable $vgpr48_vgpr49_vgpr50_vgpr51, renamable $sgpr0_sgpr1, 144, 0, implicit $exec
    ; GCN-NEXT: renamable $vgpr51 = V_ASHRREV_I32_e32 31, $vgpr37, implicit $exec
    ; GCN-NEXT: renamable $vgpr55 = V_ASHRREV_I32_e32 31, $vgpr29, implicit $exec
    ; GCN-NEXT: renamable $vgpr53 = V_ASHRREV_I32_e32 31, $vgpr28, implicit $exec
    ; GCN-NEXT: renamable $vgpr49 = V_ASHRREV_I32_e32 31, $vgpr36, implicit $exec
    ; GCN-NEXT: renamable $vgpr52 = COPY renamable $vgpr28
    ; GCN-NEXT: renamable $vgpr54 = COPY killed renamable $vgpr29
    ; GCN-NEXT: GLOBAL_STORE_DWORDX4_SADDR renamable $vgpr5, killed renamable $vgpr18_vgpr19_vgpr20_vgpr21, renamable $sgpr0_sgpr1, 96, 0, implicit $exec
    ; GCN-NEXT: renamable $vgpr21 = V_ASHRREV_I32_e32 31, $vgpr35, implicit $exec
    ; GCN-NEXT: renamable $vgpr19 = V_ASHRREV_I32_e32 31, $vgpr34, implicit $exec
    ; GCN-NEXT: renamable $vgpr18 = COPY renamable $vgpr34
    ; GCN-NEXT: renamable $vgpr20 = COPY renamable $vgpr35
    ; GCN-NEXT: renamable $vgpr48 = COPY renamable $vgpr36
    ; GCN-NEXT: renamable $vgpr50 = COPY killed renamable $vgpr37
    ; GCN-NEXT: renamable $vgpr14 = COPY renamable $vgpr22
    ; GCN-NEXT: renamable $vgpr16 = COPY renamable $vgpr23
    ; GCN-NEXT: renamable $vgpr29 = COPY renamable $vgpr24
    ; GCN-NEXT: renamable $vgpr31 = COPY killed renamable $vgpr25
    ; GCN-NEXT: renamable $vgpr10 = COPY renamable $vgpr0
    ; GCN-NEXT: renamable $vgpr12 = COPY renamable $vgpr1
    ; GCN-NEXT: GLOBAL_STORE_DWORDX4_SADDR renamable $vgpr5, killed renamable $vgpr52_vgpr53_vgpr54_vgpr55, renamable $sgpr0_sgpr1, 112, 0, implicit $exec
    ; GCN-NEXT: GLOBAL_STORE_DWORDX4_SADDR renamable $vgpr5, killed renamable $vgpr18_vgpr19_vgpr20_vgpr21, renamable $sgpr0_sgpr1, 64, 0, implicit $exec
    ; GCN-NEXT: GLOBAL_STORE_DWORDX4_SADDR renamable $vgpr5, killed renamable $vgpr48_vgpr49_vgpr50_vgpr51, renamable $sgpr0_sgpr1, 80, 0, implicit $exec
    ; GCN-NEXT: GLOBAL_STORE_DWORDX4_SADDR renamable $vgpr5, killed renamable $vgpr14_vgpr15_vgpr16_vgpr17, renamable $sgpr0_sgpr1, 32, 0, implicit $exec
    ; GCN-NEXT: GLOBAL_STORE_DWORDX4_SADDR renamable $vgpr5, killed renamable $vgpr29_vgpr30_vgpr31_vgpr32, renamable $sgpr0_sgpr1, 48, 0, implicit $exec
    ; GCN-NEXT: GLOBAL_STORE_DWORDX4_SADDR renamable $vgpr5, killed renamable $vgpr10_vgpr11_vgpr12_vgpr13, renamable $sgpr0_sgpr1, 0, 0, implicit $exec
    ; GCN-NEXT: renamable $vgpr6 = COPY renamable $vgpr2
    ; GCN-NEXT: renamable $vgpr8 = COPY killed renamable $vgpr3
    ; GCN-NEXT: GLOBAL_STORE_DWORDX4_SADDR killed renamable $vgpr5, killed renamable $vgpr6_vgpr7_vgpr8_vgpr9, killed renamable $sgpr0_sgpr1, 16, 0, implicit $exec, implicit killed renamable $vgpr4
    ; GCN-NEXT: S_ENDPGM 0
    %0:sgpr_64(p4) = COPY $sgpr4_sgpr5
    %1:vgpr_32 = COPY $m0
    %2:sgpr_128 = S_LOAD_DWORDX4_IMM %0(p4), 0, 0
    %3:vgpr_32 = V_MOV_B32_e32 %1, implicit $exec
    %4:vreg_128 = GLOBAL_LOAD_DWORDX4_SADDR %2.sub2_sub3, %3, 112, 0, implicit $exec :: (load (s128))
    %5:vreg_128 = GLOBAL_LOAD_DWORDX4_SADDR %2.sub2_sub3, %3, 96, 0, implicit $exec, implicit %1 :: (load (s128))
    %6:vreg_128 = GLOBAL_LOAD_DWORDX4_SADDR %2.sub2_sub3, %3, 80, 0, implicit $exec :: (load (s128))
    %7:vreg_128 = GLOBAL_LOAD_DWORDX4_SADDR %2.sub2_sub3, %3, 64, 0, implicit $exec :: (load (s128))
    %8:vreg_128 = GLOBAL_LOAD_DWORDX4_SADDR %2.sub2_sub3, %3, 48, 0, implicit $exec :: (load (s128))
    %9:vreg_128 = GLOBAL_LOAD_DWORDX4_SADDR %2.sub2_sub3, %3, 32, 0, implicit $exec :: (load (s128))
    %10:vreg_128 = GLOBAL_LOAD_DWORDX4_SADDR %2.sub2_sub3, %3, 16, 0, implicit $exec :: (load (s128))
    %11:vreg_128 = GLOBAL_LOAD_DWORDX4_SADDR %2.sub2_sub3, %3, 0, 0, implicit $exec :: (load (s128))
    undef %12.sub3:vreg_128 = V_ASHRREV_I32_e32 31, %11.sub3, implicit $exec
    %12.sub1:vreg_128 = V_ASHRREV_I32_e32 31, %11.sub2, implicit $exec
    undef %13.sub3:vreg_128 = V_ASHRREV_I32_e32 31, %11.sub1, implicit $exec
    %13.sub1:vreg_128 = V_ASHRREV_I32_e32 31, %11.sub0, implicit $exec
    undef %14.sub3:vreg_128 = V_ASHRREV_I32_e32 31, %10.sub3, implicit $exec
    %14.sub1:vreg_128 = V_ASHRREV_I32_e32 31, %10.sub2, implicit $exec
    undef %15.sub3:vreg_128 = V_ASHRREV_I32_e32 31, %10.sub1, implicit $exec
    %15.sub1:vreg_128 = V_ASHRREV_I32_e32 31, %10.sub0, implicit $exec
    undef %16.sub3:vreg_128 = V_ASHRREV_I32_e32 31, %9.sub3, implicit $exec
    %16.sub1:vreg_128 = V_ASHRREV_I32_e32 31, %9.sub2, implicit $exec
    undef %17.sub3:vreg_128 = V_ASHRREV_I32_e32 31, %9.sub1, implicit $exec
    %17.sub1:vreg_128 = V_ASHRREV_I32_e32 31, %9.sub0, implicit $exec
    undef %18.sub3:vreg_128 = V_ASHRREV_I32_e32 31, %8.sub3, implicit $exec
    %18.sub1:vreg_128 = V_ASHRREV_I32_e32 31, %8.sub2, implicit $exec
    undef %19.sub3:vreg_128 = V_ASHRREV_I32_e32 31, %8.sub1, implicit $exec
    %19.sub1:vreg_128 = V_ASHRREV_I32_e32 31, %8.sub0, implicit $exec
    undef %20.sub3:vreg_128 = V_ASHRREV_I32_e32 31, %7.sub3, implicit $exec
    %20.sub1:vreg_128 = V_ASHRREV_I32_e32 31, %7.sub2, implicit $exec
    undef %21.sub3:vreg_128 = V_ASHRREV_I32_e32 31, %7.sub1, implicit $exec
    %21.sub1:vreg_128 = V_ASHRREV_I32_e32 31, %7.sub0, implicit $exec
    undef %22.sub3:vreg_128 = V_ASHRREV_I32_e32 31, %6.sub3, implicit $exec
    %22.sub1:vreg_128 = V_ASHRREV_I32_e32 31, %6.sub2, implicit $exec
    undef %23.sub3:vreg_128 = V_ASHRREV_I32_e32 31, %6.sub1, implicit $exec
    %23.sub1:vreg_128 = V_ASHRREV_I32_e32 31, %6.sub0, implicit $exec
    undef %24.sub3:vreg_128 = V_ASHRREV_I32_e32 31, %5.sub3, implicit $exec
    %24.sub1:vreg_128 = V_ASHRREV_I32_e32 31, %5.sub2, implicit $exec
    undef %25.sub3:vreg_128 = V_ASHRREV_I32_e32 31, %5.sub1, implicit $exec
    %25.sub1:vreg_128 = V_ASHRREV_I32_e32 31, %5.sub0, implicit $exec
    undef %26.sub3:vreg_128 = V_ASHRREV_I32_e32 31, %4.sub3, implicit $exec
    %26.sub1:vreg_128 = V_ASHRREV_I32_e32 31, %4.sub2, implicit $exec
    undef %27.sub3:vreg_128 = V_ASHRREV_I32_e32 31, %4.sub1, implicit $exec
    %27.sub1:vreg_128 = V_ASHRREV_I32_e32 31, %4.sub0, implicit $exec
    %27.sub0:vreg_128 = COPY %4.sub0
    %27.sub2:vreg_128 = COPY %4.sub1
    GLOBAL_STORE_DWORDX4_SADDR %3, %27, %2.sub0_sub1, 224, 0, implicit $exec
    %26.sub0:vreg_128 = COPY %4.sub2
    %26.sub2:vreg_128 = COPY %4.sub3
    GLOBAL_STORE_DWORDX4_SADDR %3, %26, %2.sub0_sub1, 240, 0, implicit $exec
    %25.sub0:vreg_128 = COPY %5.sub0
    %25.sub2:vreg_128 = COPY %5.sub1
    GLOBAL_STORE_DWORDX4_SADDR %3, %25, %2.sub0_sub1, 192, 0, implicit $exec
    %24.sub0:vreg_128 = COPY %5.sub2
    %24.sub2:vreg_128 = COPY %5.sub3
    GLOBAL_STORE_DWORDX4_SADDR %3, %24, %2.sub0_sub1, 208, 0, implicit $exec
    %23.sub0:vreg_128 = COPY %6.sub0
    %23.sub2:vreg_128 = COPY %6.sub1
    GLOBAL_STORE_DWORDX4_SADDR %3, %23, %2.sub0_sub1, 160, 0, implicit $exec
    %22.sub0:vreg_128 = COPY %6.sub2
    %22.sub2:vreg_128 = COPY %6.sub3
    GLOBAL_STORE_DWORDX4_SADDR %3, %22, %2.sub0_sub1, 176, 0, implicit $exec
    %21.sub0:vreg_128 = COPY %7.sub0
    %21.sub2:vreg_128 = COPY %7.sub1
    GLOBAL_STORE_DWORDX4_SADDR %3, %21, %2.sub0_sub1, 128, 0, implicit $exec
    %20.sub0:vreg_128 = COPY %7.sub2
    %20.sub2:vreg_128 = COPY %7.sub3
    GLOBAL_STORE_DWORDX4_SADDR %3, %20, %2.sub0_sub1, 144, 0, implicit $exec
    %19.sub0:vreg_128 = COPY %8.sub0
    %19.sub2:vreg_128 = COPY %8.sub1
    GLOBAL_STORE_DWORDX4_SADDR %3, %19, %2.sub0_sub1, 96, 0, implicit $exec
    %18.sub0:vreg_128 = COPY %8.sub2
    %18.sub2:vreg_128 = COPY %8.sub3
    GLOBAL_STORE_DWORDX4_SADDR %3, %18, %2.sub0_sub1, 112, 0, implicit $exec
    %17.sub0:vreg_128 = COPY %9.sub0
    %17.sub2:vreg_128 = COPY %9.sub1
    GLOBAL_STORE_DWORDX4_SADDR %3, %17, %2.sub0_sub1, 64, 0, implicit $exec
    %16.sub0:vreg_128 = COPY %9.sub2
    %16.sub2:vreg_128 = COPY %9.sub3
    GLOBAL_STORE_DWORDX4_SADDR %3, %16, %2.sub0_sub1, 80, 0, implicit $exec
    %15.sub0:vreg_128 = COPY %10.sub0
    %15.sub2:vreg_128 = COPY %10.sub1
    GLOBAL_STORE_DWORDX4_SADDR %3, %15, %2.sub0_sub1, 32, 0, implicit $exec
    %14.sub0:vreg_128 = COPY %10.sub2
    %14.sub2:vreg_128 = COPY %10.sub3
    GLOBAL_STORE_DWORDX4_SADDR %3, %14, %2.sub0_sub1, 48, 0, implicit $exec
    %13.sub0:vreg_128 = COPY %11.sub0
    %13.sub2:vreg_128 = COPY %11.sub1
    GLOBAL_STORE_DWORDX4_SADDR %3, %13, %2.sub0_sub1, 0, 0, implicit $exec
    %12.sub0:vreg_128 = COPY %11.sub2
    %12.sub2:vreg_128 = COPY %11.sub3
    GLOBAL_STORE_DWORDX4_SADDR %3, %12, %2.sub0_sub1, 16, 0, implicit $exec, implicit killed %1
    S_ENDPGM 0

...
